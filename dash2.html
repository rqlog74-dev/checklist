<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rio Quality - Performance Individual TV</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #0f172a; color: #e2e8f0; overflow: hidden; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .glow-text-green { text-shadow: 0 0 15px rgba(74, 222, 128, 0.3); }
        .glow-text-blue { text-shadow: 0 0 15px rgba(96, 165, 250, 0.3); }
        
        /* AnimaÃ§Ã£o de Entrada */
        .fade-in { animation: fadeIn 0.8s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Barra de Tempo */
        #progress-bar { height: 4px; background: linear-gradient(90deg, #22c55e, #3b82f6); width: 0%; position: absolute; bottom: 0; left: 0; transition: width 0.1s linear; }
    </style>
</head>
<body class="h-screen flex flex-col">

    <header class="px-8 py-5 flex justify-between items-center bg-slate-900 border-b border-slate-800 relative">
        <div class="flex items-center space-x-5">
            <img src="https://www.rioquality.com.br/images/logo.webp" class="h-16 w-auto opacity-90">
            <div>
                <h1 class="text-3xl font-black tracking-wide text-white uppercase">Ranking Individual</h1>
                <p class="text-slate-400 text-sm font-bold tracking-wider uppercase mt-1">Performance Mensal (EficiÃªncia > Volume)</p>
            </div>
        </div>
        <div class="text-right">
            <p id="relogio" class="text-3xl text-white font-mono font-bold">00:00</p>
            <p id="paginacao-info" class="text-slate-500 text-sm mt-1">Carregando...</p>
        </div>
        <div id="progress-bar"></div>
    </header>

    <main class="flex-1 p-6 grid grid-cols-2 gap-8 overflow-hidden">
        
        <div class="flex flex-col h-full">
            <div class="flex items-center justify-between mb-4 px-2">
                <h2 class="text-2xl font-black text-green-400 glow-text-green flex items-center">
                    <span class="text-3xl mr-3">ðŸš›</span> TOP MOTORISTAS
                </h2>
            </div>
            <div id="lista-motoristas" class="flex-1 space-y-3 fade-in"></div>
        </div>

        <div class="flex flex-col h-full">
            <div class="flex items-center justify-between mb-4 px-2">
                <h2 class="text-2xl font-black text-blue-400 glow-text-blue flex items-center">
                    <span class="text-3xl mr-3">ðŸ“¦</span> TOP AJUDANTES
                </h2>
            </div>
            <div id="lista-ajudantes" class="flex-1 space-y-3 fade-in"></div>
        </div>

    </main>

    <script>
        // ============================================================
        // â¬‡ï¸ COLE SUAS CHAVES AQUI â¬‡ï¸
        // ============================================================
        const firebaseConfig = {
        apiKey: "AIzaSyC7Wx_vjoeu_AM9XutwCenbnsBfkRnPDOs",
        authDomain: "checklist-logistica-app.firebaseapp.com",
        projectId: "checklist-logistica-app",
        storageBucket: "checklist-logistica-app.appspot.com",
        messagingSenderId: "1016366468474",
        appId: "1:1016366468474:web:ae176857dd3d884027dac3"
    };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // CONFIGURAÃ‡ÃƒO
        const ITENS_POR_PAGINA = 6; // Quantos nomes aparecem em cada coluna
        const TEMPO_PAGINA = 15000; // Tempo para trocar de pÃ¡gina (15s)
        const TEMPO_UPDATE = 300000; // Tempo para ir no banco (5min)

        let todosMotoristas = [];
        let todosAjudantes = [];
        let paginaAtual = 0;
        let startTime = Date.now();

        // RelÃ³gio
        setInterval(() => { document.getElementById('relogio').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }, 1000);
        
        // Barra de Progresso
        setInterval(() => {
            const elapsed = Date.now() - startTime;
            const pct = Math.min((elapsed / TEMPO_PAGINA) * 100, 100);
            document.getElementById('progress-bar').style.width = pct + '%';
        }, 100);

        buscarDados();
        setInterval(buscarDados, TEMPO_UPDATE);
        setInterval(proximaPagina, TEMPO_PAGINA);

        async function buscarDados() {
            const hoje = new Date();
            
            // Pega o primeiro dia do MÃŠS PASSADO
            // Ex: Se hoje Ã© Dezembro (11), isso vira Novembro (10), dia 1
            const primeiroDiaMesPassado = new Date(hoje.getFullYear(), hoje.getMonth() - 1, 1);
            
            // Pega o Ãºltimo dia do MÃŠS PASSADO
            // O dia "0" do mÃªs atual volta um dia, caindo no Ãºltimo dia do mÃªs anterior
            const ultimoDiaMesPassado = new Date(hoje.getFullYear(), hoje.getMonth(), 0, 23, 59, 59);

            // Atualiza o tÃ­tulo na tela para a galera saber de que mÃªs estamos falando
            const nomeMes = primeiroDiaMesPassado.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
            const subTitulo = document.querySelector('p.text-slate-400'); // Pega o subtÃ­tulo do header
            if(subTitulo) subTitulo.innerText = `REFERÃŠNCIA: ${nomeMes.toUpperCase()}`;

            try {
                const snapshot = await db.collection("checklists")
                    .where('createdAt', '>=', primeiroDiaMesPassado)
                    .where('createdAt', '<=', ultimoDiaMesPassado)
                    .get();

                const dados = snapshot.docs.map(doc => doc.data());
                processarDados(dados); // Ou processarDadosIndividuais dependendo do arquivo
            } catch (error) {
                console.error("Erro na TV:", error);
            }
        }

        function processarDados(dados) {
            const stats = {}; // Chave: Nome, Valor: { cargo, total, perfeitas }

            dados.forEach(item => {
                const mot = norm(item.secao3?.motorista);
                if (!mot) return; // Ignora checklist sem dono

                const aju1 = norm(item.secao3?.ajudante1);
                const aju2 = norm(item.secao3?.ajudante2);

                // Checa se foi 100%
                const teveFalta = (item.secao2?.divergencia_falta || []).length > 0;
                const teveSobra = (item.secao2?.sobras || []).length > 0;
                const teveComp = item.secao1?.comportamento === 'Sim';
                const isPerfect = !teveFalta && !teveSobra && !teveComp;

                const computar = (nome, cargo) => {
                    if (!nome) return;
                    if (!stats[nome]) stats[nome] = { nome, cargo, total: 0, perfeitas: 0 };
                    stats[nome].total++;
                    if(isPerfect) stats[nome].perfeitas++;
                    if(cargo === 'MOT') stats[nome].cargo = 'MOT'; // Prioridade pro cargo Motorista
                };

                computar(mot, 'MOT');
                computar(aju1, 'AJU');
                computar(aju2, 'AJU');
            });

            // FunÃ§Ã£o de OrdenaÃ§Ã£o (100% primeiro, depois volume)
            const sortFn = (a, b) => {
                // 1. Quem tem MAIS viagens ganha
                if (b.total !== a.total) return b.total - a.total;
                
                // 2. Desempate: Quem tem maior % ganha
                const pctA = a.perfeitas / a.total;
                const pctB = b.perfeitas / b.total;
                return pctB - pctA;
            };

            // Filtra e Ordena (MÃ­nimo 1 viagem para aparecer todo mundo)
            const listaCompleta = Object.values(stats);
            todosMotoristas = listaCompleta.filter(p => p.cargo === 'MOT' && p.total >= 1).sort(sortFn);
            todosAjudantes = listaCompleta.filter(p => p.cargo === 'AJU' && p.total >= 1).sort(sortFn);

            paginaAtual = 0;
            startTime = Date.now();
            renderizarPagina();
        }

        function proximaPagina() {
            // Calcula qual Ã© a maior lista para saber quantas pÃ¡ginas tem no total
            const maiorLista = Math.max(todosMotoristas.length, todosAjudantes.length);
            const totalPaginas = Math.ceil(maiorLista / ITENS_POR_PAGINA);

            paginaAtual++;
            if (paginaAtual >= totalPaginas) paginaAtual = 0;
            
            startTime = Date.now();
            renderizarPagina();
        }

        function renderizarPagina() {
            const containerMot = document.getElementById('lista-motoristas');
            const containerAju = document.getElementById('lista-ajudantes');
            const infoPag = document.getElementById('paginacao-info');

            // Limpa e Reinicia AnimaÃ§Ã£o
            containerMot.innerHTML = ''; containerAju.innerHTML = '';
            containerMot.classList.remove('fade-in'); containerAju.classList.remove('fade-in');
            void containerMot.offsetWidth; 
            containerMot.classList.add('fade-in'); containerAju.classList.add('fade-in');

            const inicio = paginaAtual * ITENS_POR_PAGINA;
            const fim = inicio + ITENS_POR_PAGINA;

            // Fatiar as listas
            const paginaMot = todosMotoristas.slice(inicio, fim);
            const paginaAju = todosAjudantes.slice(inicio, fim);
            
            // Atualiza Info
            const totalPaginas = Math.ceil(Math.max(todosMotoristas.length, todosAjudantes.length) / ITENS_POR_PAGINA) || 1;
            infoPag.innerText = `PÃ¡gina ${paginaAtual + 1}/${totalPaginas}`;

            // FunÃ§Ã£o para gerar o HTML do Card
            const criarCard = (p, indexAbsoluto, corTema) => {
                if (!p) return ''; // EspaÃ§o vazio se a lista for menor
                const rank = indexAbsoluto + 1;
                const pct = Math.round((p.perfeitas / p.total) * 100);
                
                let borderClass = 'border-slate-700';
                let textClass = 'text-gray-400';
                let bgClass = '';

                if (pct === 100) {
                    borderClass = `border-${corTema}-500`;
                    textClass = `text-${corTema}-400`;
                    bgClass = `bg-${corTema}-500 bg-opacity-10`;
                } else if (pct >= 90) {
                    borderClass = 'border-slate-600';
                    textClass = 'text-white';
                }

                return `
                    <div class="glass-panel p-4 rounded-xl flex items-center justify-between border-l-4 ${borderClass} ${bgClass} mb-3">
                        <div class="flex items-center min-w-0">
                            <span class="text-3xl font-black text-slate-600 w-12 text-center mr-3">${rank}Âº</span>
                            <div class="min-w-0">
                                <h3 class="text-xl font-bold text-white truncate pr-2" title="${p.nome}">${p.nome}</h3>
                                <p class="text-sm text-slate-400">${p.perfeitas} de ${p.total} perfeitas</p>
                            </div>
                        </div>
                        <div class="text-right pl-2">
                            <span class="text-3xl font-black ${textClass}">${pct}%</span>
                        </div>
                    </div>
                `;
            };

            // Renderiza Motoristas
            if (paginaMot.length === 0 && paginaAtual === 0) containerMot.innerHTML = '<p class="text-slate-500 text-center mt-10">Sem dados.</p>';
            else paginaMot.forEach((m, i) => containerMot.innerHTML += criarCard(m, inicio + i, 'green'));

            // Renderiza Ajudantes
            if (paginaAju.length === 0 && paginaAtual === 0) containerAju.innerHTML = '<p class="text-slate-500 text-center mt-10">Sem dados.</p>';
            else paginaAju.forEach((a, i) => containerAju.innerHTML += criarCard(a, inicio + i, 'blue'));
        }
    </script>
</body>
</html>