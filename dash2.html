<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rio Quality - Ranking Individual TV</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #0f172a; color: #e2e8f0; overflow: hidden; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .glow-text-green { text-shadow: 0 0 15px rgba(74, 222, 128, 0.3); }
        .glow-text-blue { text-shadow: 0 0 15px rgba(96, 165, 250, 0.3); }
        
        .fade-in { animation: fadeIn 0.8s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        
        #progress-bar { height: 4px; background: linear-gradient(90deg, #22c55e, #3b82f6); width: 0%; position: absolute; bottom: 0; left: 0; transition: width 0.1s linear; }
    </style>
</head>
<body class="h-screen flex flex-col">

    <header class="px-8 py-5 flex justify-between items-center bg-slate-900 border-b border-slate-800 relative">
        <div class="flex items-center space-x-5">
            <img src="https://www.rioquality.com.br/images/logo.webp" class="h-16 w-auto opacity-90">
            <div>
                <h1 class="text-3xl font-black tracking-wide text-white uppercase">Ranking Individual</h1>
                <p class="text-slate-400 text-sm font-bold tracking-wider uppercase mt-1">Performance MÃªs Anterior (EficiÃªncia > Volume)</p>
            </div>
        </div>
        <div class="text-right">
            <p id="relogio" class="text-3xl text-white font-mono font-bold">00:00</p>
            <p id="paginacao-info" class="text-slate-500 text-sm mt-1">Carregando...</p>
        </div>
        <div id="progress-bar"></div>
    </header>

    <main class="flex-1 p-6 grid grid-cols-2 gap-8 overflow-hidden">
        
        <div class="flex flex-col h-full">
            <div class="flex items-center justify-between mb-4 px-2 border-b border-slate-700 pb-2">
                <h2 class="text-2xl font-black text-green-400 glow-text-green flex items-center">
                    <span class="text-3xl mr-3">ðŸš›</span> TOP MOTORISTAS
                </h2>
            </div>
            <div id="lista-motoristas" class="flex-1 space-y-3 fade-in"></div>
        </div>

        <div class="flex flex-col h-full">
            <div class="flex items-center justify-between mb-4 px-2 border-b border-slate-700 pb-2">
                <h2 class="text-2xl font-black text-blue-400 glow-text-blue flex items-center">
                    <span class="text-3xl mr-3">ðŸ“¦</span> TOP AJUDANTES
                </h2>
            </div>
            <div id="lista-ajudantes" class="flex-1 space-y-3 fade-in"></div>
        </div>

    </main>

    <script>
        const firebaseConfig = {
        apiKey: "AIzaSyC7Wx_vjoeu_AM9XutwCenbnsBfkRnPDOs",
        authDomain: "checklist-logistica-app.firebaseapp.com",
        projectId: "checklist-logistica-app",
        storageBucket: "checklist-logistica-app.appspot.com",
        messagingSenderId: "1016366468474",
        appId: "1:1016366468474:web:ae176857dd3d884027dac3"
    };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const ITENS_POR_PAGINA = 6; 
        const TEMPO_PAGINA = 15000; 
        const TEMPO_UPDATE = 300000; 

        let todosMotoristas = [];
        let todosAjudantes = [];
        let paginaAtual = 0;
        let startTime = Date.now();

        setInterval(() => { document.getElementById('relogio').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }, 1000);
        
        setInterval(() => {
            const elapsed = Date.now() - startTime;
            const pct = Math.min((elapsed / TEMPO_PAGINA) * 100, 100);
            document.getElementById('progress-bar').style.width = pct + '%';
        }, 100);

        buscarDados();
        setInterval(buscarDados, TEMPO_UPDATE);
        setInterval(proximaPagina, TEMPO_PAGINA);

        function norm(nome) {
            if(!nome || nome === 'N/A' || nome.trim() === '') return null;
            return nome.trim().toUpperCase();
        }

        async function buscarDados() {
            const hoje = new Date();
            const passado = new Date();
            passado.setDate(hoje.getDate() - 30); // <--- PEGA OS ÃšLTIMOS 30 DIAS ATRÃS

            try {
                const snapshot = await db.collection("checklists")
                    .where('createdAt', '>=', passado)
                    .get();

                const dados = snapshot.docs.map(doc => doc.data());
                processarDados(dados);
            } catch (error) {
                console.error("Erro:", error);
            }
        }

        function processarDados(dados) {
            const stats = {}; 

            dados.forEach(item => {
                const mot = norm(item.secao3?.motorista);
                if (!mot) return; 

                const aju1 = norm(item.secao3?.ajudante1);
                const aju2 = norm(item.secao3?.ajudante2);

                const teveFalta = (item.secao2?.divergencia_falta || []).length > 0;
                const teveSobra = (item.secao2?.sobras || []).length > 0;
                const teveComp = item.secao1?.comportamento === 'Sim';
                const isPerfect = !teveFalta && !teveSobra && !teveComp;

                const computar = (nome, cargo) => {
                    if (!nome) return;
                    if (!stats[nome]) stats[nome] = { nome, cargo, total: 0, perfeitas: 0 };
                    stats[nome].total++;
                    if(isPerfect) stats[nome].perfeitas++;
                    if(cargo === 'MOT') stats[nome].cargo = 'MOT';
                };

                computar(mot, 'MOT');
                computar(aju1, 'AJU');
                computar(aju2, 'AJU');
            });

            const todos = Object.values(stats);
            
            // === ORDENAÃ‡ÃƒO IGUAL AO DASHBOARD CLARO ===
            const sortFn = (a, b) => {
                const pctA = a.perfeitas / a.total;
                const pctB = b.perfeitas / b.total;
                // 1. EficiÃªncia
                if (Math.abs(pctB - pctA) > 0.001) return pctB - pctA; 
                // 2. Volume
                return b.total - a.total; 
            };

            todosMotoristas = todos.filter(p => p.cargo === 'MOT' && p.total >= 3).sort(sortFn);
            todosAjudantes = todos.filter(p => p.cargo === 'AJU' && p.total >= 3).sort(sortFn);

            paginaAtual = 0;
            startTime = Date.now();
            renderizarPagina();
        }

        function proximaPagina() {
            const maiorLista = Math.max(todosMotoristas.length, todosAjudantes.length);
            const totalPaginas = Math.ceil(maiorLista / ITENS_POR_PAGINA) || 1;

            paginaAtual++;
            if (paginaAtual >= totalPaginas) paginaAtual = 0;
            
            startTime = Date.now();
            renderizarPagina();
        }

        function renderizarPagina() {
            const containerMot = document.getElementById('lista-motoristas');
            const containerAju = document.getElementById('lista-ajudantes');
            const infoPag = document.getElementById('paginacao-info');

            containerMot.innerHTML = ''; containerAju.innerHTML = '';
            containerMot.classList.remove('fade-in'); containerAju.classList.remove('fade-in');
            void containerMot.offsetWidth; 
            containerMot.classList.add('fade-in'); containerAju.classList.add('fade-in');

            const inicio = paginaAtual * ITENS_POR_PAGINA;
            const fim = inicio + ITENS_POR_PAGINA;

            const paginaMot = todosMotoristas.slice(inicio, fim);
            const paginaAju = todosAjudantes.slice(inicio, fim);
            
            const totalPaginas = Math.ceil(Math.max(todosMotoristas.length, todosAjudantes.length) / ITENS_POR_PAGINA) || 1;
            infoPag.innerText = `PÃ¡gina ${paginaAtual + 1} de ${totalPaginas}`;

            // FunÃ§Ã£o que cria o card COM BARRA DE PROGRESSO
            const criarCard = (p, indexAbsoluto, corTema) => {
                if (!p) return ''; 
                const rank = indexAbsoluto + 1;
                const pct = Math.round((p.perfeitas / p.total) * 100);
                
                let borderClass = 'border-slate-700';
                let textClass = 'text-gray-400';
                let barColor = 'bg-red-500';

                if (pct === 100) {
                    borderClass = `border-${corTema}-500`;
                    textClass = `text-${corTema}-400 glow-text-${corTema}`;
                    barColor = 'bg-green-500'; // Verde Vivo
                } else if (pct >= 90) {
                    borderClass = 'border-green-700';
                    textClass = 'text-green-200';
                    barColor = 'bg-green-400';
                } else if (pct >= 70) {
                    barColor = 'bg-yellow-400'; // Amarelo
                } else {
                    barColor = 'bg-red-500'; // Vermelho
                }

                return `
                    <div class="glass-panel p-4 rounded-xl border-l-4 ${borderClass} shadow-lg mb-3">
                        <div class="flex justify-between items-center mb-2">
                            <div class="flex items-center min-w-0">
                                <span class="text-3xl font-black text-slate-600 w-10 text-center mr-3">#${rank}</span>
                                <div class="min-w-0">
                                    <h3 class="text-lg font-bold text-white truncate pr-2" title="${p.nome}">${p.nome}</h3>
                                    <p class="text-xs text-slate-400">${p.perfeitas} de ${p.total} perfeitas</p>
                                </div>
                            </div>
                            <div class="text-right pl-2">
                                <span class="text-3xl font-black ${textClass}">${pct}%</span>
                            </div>
                        </div>
                        
                        <div class="w-full bg-slate-700 rounded-full h-2 overflow-hidden">
                            <div class="${barColor} h-2 rounded-full" style="width: ${pct}%"></div>
                        </div>
                    </div>
                `;
            };

            if (paginaMot.length === 0 && paginaAtual === 0) containerMot.innerHTML = '<p class="text-slate-500 text-center mt-10">Sem dados.</p>';
            else paginaMot.forEach((m, i) => containerMot.innerHTML += criarCard(m, inicio + i, 'green'));

            if (paginaAju.length === 0 && paginaAtual === 0) containerAju.innerHTML = '<p class="text-slate-500 text-center mt-10">Sem dados.</p>';
            else paginaAju.forEach((a, i) => containerAju.innerHTML += criarCard(a, inicio + i, 'blue'));
        }
    </script>
</body>
</html>