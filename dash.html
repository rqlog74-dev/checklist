<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rio Quality - Painel de Alertas</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700;900&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #0f172a; color: #e2e8f0; overflow: hidden; }
        .glass-panel { background: rgba(30, 41, 59, 0.7); backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
        .glow-text { text-shadow: 0 0 20px rgba(255,255,255,0.1); }
        
        /* Anima√ß√£o */
        .fade-in { animation: fadeIn 0.8s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        
        /* Barra de Progresso (Cor de Alerta) */
        #progress-bar { height: 6px; background: linear-gradient(90deg, #f59e0b, #ef4444); width: 0%; position: absolute; bottom: 0; left: 0; transition: width 0.1s linear; }
    </style>
</head>
<body class="h-screen flex flex-col">

    <header class="p-6 flex justify-between items-center bg-slate-900 border-b border-slate-800 relative">
        <div class="flex items-center space-x-4">
            <img src="https://www.rioquality.com.br/images/logo.webp" class="h-16 w-auto opacity-80">
            <div>
                <h1 class="text-3xl font-black tracking-widest text-white uppercase">Monitoramento de Risco</h1>
                <p class="text-sm text-red-400 uppercase tracking-widest font-bold">REGISTROS DO M√äS</p>
                <p id="relogio" class="text-xl text-slate-400 font-mono mt-1">00:00:00</p>
            </div>
        </div>
        <div class="text-right">
            <h2 id="titulo-slide" class="text-4xl font-bold text-white glow-text">CARREGANDO...</h2>
            <p id="subtitulo-slide" class="text-slate-500 text-sm">Atualiza√ß√£o autom√°tica</p>
        </div>
        <div id="progress-bar"></div>
    </header>

    <main class="flex-1 p-8 flex flex-col justify-center">
        <div id="container-dados" class="grid grid-cols-1 gap-6 fade-in">
            </div>
    </main>

    <footer class="p-4 bg-slate-900 border-t border-slate-800 flex justify-around text-center text-xl font-bold">
        <div class="text-red-500">TOTAL FALTAS: <span id="footer-falta" class="text-white">0</span></div>
        <div class="text-blue-500">TOTAL SOBRAS: <span id="footer-sobra" class="text-white">0</span></div>
    </footer>

    <script>
        // ============================================================
        // ‚¨áÔ∏è COLE SUAS CHAVES AQUI ‚¨áÔ∏è
        // ============================================================
        const firebaseConfig = {
        apiKey: "AIzaSyC7Wx_vjoeu_AM9XutwCenbnsBfkRnPDOs",
        authDomain: "checklist-logistica-app.firebaseapp.com",
        projectId: "checklist-logistica-app",
        storageBucket: "checklist-logistica-app.appspot.com",
        messagingSenderId: "1016366468474",
        appId: "1:1016366468474:web:ae176857dd3d884027dac3"
    };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        const TEMPO_SLIDE = 10000; // 10 segundos
        const TEMPO_UPDATE = 300000; // 5 minutos
        
        let dadosEquipes = [];
        let dadosVeiculos = [];
        let dadosProdutos = []; 
        let slideAtual = 0; 
        let startTime = Date.now();

        setInterval(() => { document.getElementById('relogio').innerText = new Date().toLocaleTimeString(); }, 1000);
        
        setInterval(() => {
            const elapsed = Date.now() - startTime;
            const pct = Math.min((elapsed / TEMPO_SLIDE) * 100, 100);
            document.getElementById('progress-bar').style.width = pct + '%';
        }, 100);

        buscarDados();
        setInterval(buscarDados, TEMPO_UPDATE);
        setInterval(proximoSlide, TEMPO_SLIDE);

        async function buscarDados() {
            const hoje = new Date();
            const passado = new Date();
            passado.setDate(hoje.getDate() - 30); // √öltimos 30 dias

            try {
                const snapshot = await db.collection("checklists")
                    .where('createdAt', '>=', passado)
                    .get();

                const dados = snapshot.docs.map(doc => doc.data());
                processarDados(dados);
            } catch (error) {
                console.error("Erro na TV:", error);
            }
        }

        function processarDados(dados) {
            const equipes = {};
            const veiculos = {};
            const produtos = {};
            let totalFalta = 0, totalSobra = 0;

            dados.forEach(item => {
                const listaFaltas = item.secao2?.divergencia_falta || [];
                const teveFalta = listaFaltas.length > 0;
                const teveSobra = (item.secao2?.sobras || []).length > 0;

                // === EQUIPE ===
                const mot = item.secao3?.motorista || '';
                if (mot && mot !== 'N/A' && mot.trim() !== '') {
                    const aju1 = item.secao3?.ajudante1 || '';
                    const aju2 = item.secao3?.ajudante2 || '';
                    
                    let teamKey = mot.split(' ')[0];
                    if(aju1 && aju1 !== 'N/A') teamKey += '+' + aju1.split(' ')[0];
                    if(aju2 && aju2 !== 'N/A') teamKey += '+' + aju2.split(' ')[0];

                    let htmlNome = `<span class="inline-block text-[10px] font-bold bg-blue-600 text-white px-2 py-1 rounded mr-2 align-middle tracking-wider">MOT</span>${mot.split(' ')[0]}`;
                    if(aju1 && aju1 !== 'N/A') htmlNome += ` <span class="text-slate-500 text-sm mx-2">+</span> <span class="inline-block text-[10px] font-bold bg-purple-600 text-white px-2 py-1 rounded mr-2 align-middle tracking-wider">AJU</span>${aju1.split(' ')[0]}`;
                    if(aju2 && aju2 !== 'N/A') htmlNome += ` <span class="text-slate-500 text-sm mx-2">+</span> <span class="inline-block text-[10px] font-bold bg-purple-600 text-white px-2 py-1 rounded mr-2 align-middle tracking-wider">AJU</span>${aju2.split(' ')[0]}`;

                    if(!equipes[teamKey]) equipes[teamKey] = { nomeHtml: htmlNome, viagens: 0, faltas: 0 };
                    equipes[teamKey].viagens++;
                    if(teveFalta) equipes[teamKey].faltas++;
                }

                // === VE√çCULOS ===
                const placa = item.secao1?.veiculo || 'N/A';
                if (placa !== 'N/A' && placa.trim() !== '') {
                    if(!veiculos[placa]) veiculos[placa] = { placa: placa, viagens: 0, faltas: 0 };
                    veiculos[placa].viagens++;
                    if(teveFalta) veiculos[placa].faltas++;
                }

                // === PRODUTOS ===
                if (teveFalta) {
                    totalFalta++;
                    listaFaltas.forEach(f => {
                        let nomeProd = f.descricao || f.produto || 'Produto s/ Nome';
                        if(f.produto && f.descricao) nomeProd = `[${f.produto}] ${f.descricao}`;
                        if(!produtos[nomeProd]) produtos[nomeProd] = { nome: nomeProd, qtd: 0 };
                        produtos[nomeProd].qtd += parseInt(f.qtd || 1);
                    });
                }

                if(teveSobra) totalSobra++;
            });

            document.getElementById('footer-falta').innerText = totalFalta;
            document.getElementById('footer-sobra').innerText = totalSobra;

            dadosEquipes = Object.values(equipes);
            dadosVeiculos = Object.values(veiculos);
            dadosProdutos = Object.values(produtos);
            
            renderizarSlide();
        }

        function proximoSlide() {
            slideAtual++;
            if(slideAtual > 2) slideAtual = 0; // Apenas 3 slides de alerta (0, 1, 2)
            startTime = Date.now();
            renderizarSlide();
        }

        function renderizarSlide() {
            const container = document.getElementById('container-dados');
            const titulo = document.getElementById('titulo-slide');
            const sub = document.getElementById('subtitulo-slide');
            container.innerHTML = '';
            
            container.classList.remove('fade-in');
            void container.offsetWidth; 
            container.classList.add('fade-in');

            // === SLIDE 0: EQUIPES COM FALTA (Laranja) ===
            if (slideAtual === 0) {
                 titulo.className = "text-4xl font-bold text-orange-400 glow-text";
                 titulo.innerText = "‚ö†Ô∏è EQUIPES COM MAIS FALTAS";
                 sub.innerText = "Registros no sistema";
                 const alertas = dadosEquipes.filter(e => e.faltas > 0).sort((a,b) => b.faltas - a.faltas).slice(0, 5);
                 
                 if (alertas.length === 0) { container.innerHTML = '<h3 class="text-center text-green-500 text-2xl mt-10">Nenhuma falta de equipe registrada!</h3>'; return; }

                 alertas.forEach((e, i) => {
                    container.innerHTML += `
                        <div class="glass-panel p-5 rounded-2xl flex items-center justify-between border-l-8 border-orange-500">
                            <div class="flex items-center w-3/4">
                                <span class="text-5xl font-black text-slate-600 mr-6">${i+1}</span>
                                <div>
                                    <h3 class="text-2xl font-bold text-slate-200 flex flex-wrap items-center">${e.nomeHtml}</h3>
                                    <p class="text-orange-400 text-lg mt-1">${e.viagens} viagens no total</p>
                                </div>
                            </div>
                            <div class="text-right"><span class="text-4xl font-black text-white">${e.faltas}</span><span class="block text-xs text-slate-400 uppercase">Ocorr√™ncias</span></div>
                        </div>`;
                 });

            // === SLIDE 1: VE√çCULOS (Azul) ===
            } else if (slideAtual === 1) {
                 titulo.className = "text-4xl font-bold text-blue-400 glow-text";
                 titulo.innerText = "üîß VE√çCULOS COM MAIS FALTAS";
                 sub.innerText = "Faltas registradas";
                 const veicAlertas = dadosVeiculos.filter(v => v.faltas > 0).sort((a,b) => b.faltas - a.faltas).slice(0, 5);
                 
                 if (veicAlertas.length === 0) { container.innerHTML = '<h3 class="text-center text-green-500 text-2xl mt-10">Frota operando 100% (Sem faltas).</h3>'; return; }
                 
                 veicAlertas.forEach((v, i) => {
                    container.innerHTML += `<div class="glass-panel p-5 rounded-2xl flex items-center justify-between border-l-8 border-blue-500"><div class="flex items-center"><span class="text-5xl font-black text-slate-600 mr-6">${i+1}</span><div><h3 class="text-3xl font-bold text-white">${v.placa}</h3><p class="text-blue-400 text-lg">Faltas registradas neste carro</p></div></div><div class="text-right"><span class="text-4xl font-black text-red-400">${v.faltas}</span><span class="block text-xs text-slate-400 uppercase">Cargas c/ Problema</span></div></div>`;
                 });

            // === SLIDE 2: PRODUTOS (Roxo) ===
            } else {
                 titulo.className = "text-4xl font-bold text-purple-400 glow-text";
                 titulo.innerText = "üì¶ PRODUTOS COM MAIS FALTA";
                 sub.innerText = "Faltas registradas";
                 const prodAlertas = dadosProdutos.sort((a,b) => b.qtd - a.qtd).slice(0, 5);
                 
                 if (prodAlertas.length === 0) { container.innerHTML = '<h3 class="text-center text-green-500 text-2xl mt-10">Nenhum produto com falta!</h3>'; return; }
                 
                 prodAlertas.forEach((p, i) => {
                    container.innerHTML += `<div class="glass-panel p-5 rounded-2xl flex items-center justify-between border-l-8 border-purple-500"><div class="flex items-center overflow-hidden"><span class="text-5xl font-black text-slate-600 mr-6 flex-shrink-0">#${i+1}</span><div class="min-w-0"><h3 class="text-2xl font-bold text-white truncate pr-4">${p.nome}</h3><p class="text-purple-400 text-lg">Item cr√≠tico do per√≠odo</p></div></div><div class="text-right flex-shrink-0"><span class="text-4xl font-black text-red-400">${p.qtd}</span><span class="block text-xs text-slate-400 uppercase">Unidades Registradas</span></div></div>`;
                 });
            }
        }
    </script>
</body>
</html>