<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rio Quality - Comparativo TV</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700;900&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        body { font-family: 'Roboto', sans-serif; background-color: #0f172a; color: #e2e8f0; overflow: hidden; }
        
        /* Design Compacto para TV */
        .glass-panel { background: rgba(30, 41, 59, 0.6); backdrop-filter: blur(8px); border: 1px solid rgba(255, 255, 255, 0.05); }
        .glow-text { text-shadow: 0 0 15px rgba(255,255,255,0.1); }
        
        /* Animação */
        .fade-in { animation: fadeIn 0.6s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.99); } to { opacity: 1; transform: scale(1); } }
        
        #progress-bar { height: 4px; background: linear-gradient(90deg, #3b82f6, #8b5cf6); width: 0%; position: absolute; bottom: 0; left: 0; transition: width 0.1s linear; }
        
        /* Scroll Invisível */
        .thin-scroll::-webkit-scrollbar { width: 0px; }
    </style>
</head>
<body class="h-screen flex flex-col">

    <header class="px-6 py-3 flex justify-between items-center bg-slate-900 border-b border-slate-800 relative z-20">
        <div class="flex items-center space-x-4">
            <img src="https://www.rioquality.com.br/images/logo.webp" class="h-14 w-auto opacity-90">
            <div>
                <h1 class="text-2xl font-black tracking-wide text-white uppercase">RANKING TOP 12</h1>
                <p id="titulo-cargo" class="text-blue-400 text-sm font-bold tracking-widest uppercase">COMPARATIVO: MOTORISTAS</p>
            </div>
        </div>
        <div class="text-right">
            <p id="relogio" class="text-2xl text-white font-mono font-bold">00:00</p>
            <p class="text-xs text-slate-500 uppercase tracking-widest mt-1">Atualização: Semanal</p>
        </div>
        <div id="progress-bar"></div>
    </header>

    <main class="flex-1 p-4 grid grid-cols-2 gap-4 overflow-hidden relative">
        
        <div class="flex flex-col h-full bg-slate-800/40 rounded-xl border border-slate-700/50 overflow-hidden">
            <div class="p-2 bg-slate-800/80 border-b border-slate-700 text-center">
                <h2 id="lbl-anterior" class="text-lg font-bold text-slate-400 uppercase tracking-wider">MÊS PASSADO</h2>
            </div>
            <div id="lista-anterior" class="flex-1 p-2 space-y-1.5 overflow-y-auto thin-scroll fade-in"></div>
        </div>

        <div class="flex flex-col h-full bg-slate-800/40 rounded-xl border border-slate-700/50 overflow-hidden relative">
            <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-green-400 to-blue-500"></div>
            <div class="p-2 bg-slate-800/80 border-b border-slate-700 text-center">
                <h2 id="lbl-atual" class="text-lg font-bold text-white uppercase tracking-wider glow-text">MÊS ATUAL</h2>
            </div>
            <div id="lista-atual" class="flex-1 p-2 space-y-1.5 overflow-y-auto thin-scroll fade-in"></div>
        </div>

        <div class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-slate-900 border border-slate-600 rounded-full p-2 shadow-xl z-10">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" /></svg>
        </div>

    </main>

    <script>
        // ============================================================
        // ⬇️ COLE SUAS CHAVES AQUI ⬇️
        // ============================================================
        const firebaseConfig = {
        apiKey: "AIzaSyC7Wx_vjoeu_AM9XutwCenbnsBfkRnPDOs",
        authDomain: "checklist-logistica-app.firebaseapp.com",
        projectId: "checklist-logistica-app",
        storageBucket: "checklist-logistica-app.appspot.com",
        messagingSenderId: "1016366468474",
        appId: "1:1016366468474:web:ae176857dd3d884027dac3"
    };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // --- CONFIGURAÇÃO DE ECONOMIA ---
        const TEMPO_SLIDE = 15000; // 15 segundos por tela (Visual)
        const TEMPO_UPDATE = 604800000; // 7 DIAS (Economia de Leitura)
        
        let dadosAnterior = [];
        let dadosAtual = [];
        let slideAtual = 0; // 0 = Motoristas, 1 = Ajudantes
        let startTime = Date.now();

        setInterval(() => { document.getElementById('relogio').innerText = new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}); }, 1000);
        
        setInterval(() => {
            const elapsed = Date.now() - startTime;
            const pct = Math.min((elapsed / TEMPO_SLIDE) * 100, 100);
            document.getElementById('progress-bar').style.width = pct + '%';
        }, 100);

        init();

        function init() {
            buscarDados();
            setInterval(buscarDados, TEMPO_UPDATE);
            setInterval(alternarCargo, TEMPO_SLIDE);
        }

        async function buscarDados() {
            const hoje = new Date();
            
            // Datas Mês Atual
            const inicioAtual = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
            
            // Datas Mês Anterior (Dia 1 até o ultimo dia)
            const inicioAnterior = new Date(hoje.getFullYear(), hoje.getMonth() - 1, 1);
            const fimAnterior = new Date(hoje.getFullYear(), hoje.getMonth(), 0, 23, 59, 59);

            // Atualiza nomes dos meses na tela
            document.getElementById('lbl-atual').innerText = inicioAtual.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' }).toUpperCase();
            document.getElementById('lbl-anterior').innerText = inicioAnterior.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' }).toUpperCase();

            try {
                // Busca Paralela
                const [snapAnterior, snapAtual] = await Promise.all([
                    db.collection("checklists").where('createdAt', '>=', inicioAnterior).where('createdAt', '<=', fimAnterior).get(),
                    db.collection("checklists").where('createdAt', '>=', inicioAtual).get()
                ]);

                const rawAnterior = snapAnterior.docs.map(d => d.data());
                const rawAtual = snapAtual.docs.map(d => d.data());

                dadosAnterior = processarStats(rawAnterior);
                dadosAtual = processarStats(rawAtual);

                renderizarTela();

            } catch (error) {
                console.error("Erro:", error);
            }
        }

        function norm(nome) {
            if(!nome || nome === 'N/A' || nome.trim() === '') return null;
            return nome.trim().toUpperCase();
        }

        function processarStats(listaChecklists) {
            const stats = {}; 

            listaChecklists.forEach(item => {
                const mot = norm(item.secao3?.motorista);
                const aju1 = norm(item.secao3?.ajudante1);
                const aju2 = norm(item.secao3?.ajudante2);

                if (!mot) return;

                const teveFalta = (item.secao2?.divergencia_falta || []).length > 0;
                const teveSobra = (item.secao2?.sobras || []).length > 0;
                const teveComp = item.secao1?.comportamento === 'Sim';
                const isPerfect = !teveFalta && !teveSobra && !teveComp;

                const computar = (nome, cargo) => {
                    if (!nome) return;
                    if (!stats[nome]) stats[nome] = { nome, cargo, viagens: 0, perfeitas: 0 };
                    
                    stats[nome].viagens++;
                    if (isPerfect) stats[nome].perfeitas++;
                    if (cargo === 'MOT') stats[nome].cargo = 'MOT';
                };

                computar(mot, 'MOT');
                computar(aju1, 'AJU');
                computar(aju2, 'AJU');
            });

            return Object.values(stats).sort((a, b) => {
                const pctA = a.perfeitas / a.viagens;
                const pctB = b.perfeitas / b.viagens;
                if (Math.abs(pctB - pctA) > 0.001) return pctB - pctA; 
                return b.viagens - a.viagens; 
            });
        }

        function alternarCargo() {
            slideAtual = slideAtual === 0 ? 1 : 0;
            startTime = Date.now();
            renderizarTela();
        }

        function renderizarTela() {
            const containerAnt = document.getElementById('lista-anterior');
            const containerAtu = document.getElementById('lista-atual');
            const titulo = document.getElementById('titulo-cargo');
            
            // Configurações do Slide
            const cargo = slideAtual === 0 ? 'MOT' : 'AJU';
            const nomeCargo = slideAtual === 0 ? 'MOTORISTAS' : 'AJUDANTES';
            const corTexto = slideAtual === 0 ? 'text-blue-400' : 'text-purple-400';
            
            titulo.innerText = `COMPARATIVO: ${nomeCargo}`;
            titulo.className = `${corTexto} text-sm font-bold tracking-widest uppercase mt-0.5`;
            document.getElementById('progress-bar').className = slideAtual === 0 ? 'bg-blue-500' : 'bg-purple-500';

            // Filtra TOP 12 para caber na tela sem rolar (Compacto)
            const listaAnt = dadosAnterior.filter(p => p.cargo === cargo && p.viagens >= 3).slice(0, 12);
            const listaAtu = dadosAtual.filter(p => p.cargo === cargo && p.viagens >= 3).slice(0, 12);

            containerAnt.innerHTML = '';
            containerAtu.innerHTML = '';
            
            // Animação
            containerAnt.classList.remove('fade-in'); containerAtu.classList.remove('fade-in');
            void containerAnt.offsetWidth; 
            containerAnt.classList.add('fade-in'); containerAtu.classList.add('fade-in');

            renderizarLista(containerAnt, listaAnt, false);
            renderizarLista(containerAtu, listaAtu, true);
        }

        function renderizarLista(container, lista, isAtual) {
            if (lista.length === 0) {
                container.innerHTML = '<div class="text-center mt-20 text-slate-600 text-sm">Sem dados.</div>';
                return;
            }

            lista.forEach((p, i) => {
                const rank = i + 1;
                const pct = Math.round((p.perfeitas / p.viagens) * 100);
                
                // Cores Compactas
                let barColor = 'bg-slate-600';
                let pctColor = 'text-slate-400';
                if (pct === 100) { barColor = 'bg-green-500'; pctColor = 'text-green-400'; }
                else if (pct >= 90) { barColor = 'bg-green-600'; pctColor = 'text-green-200'; }
                else if (pct < 60) { barColor = 'bg-red-500'; pctColor = 'text-red-400'; }

                // Se for o mês atual, destaca levemente
                const bgCard = isAtual ? 'bg-slate-700/40' : 'bg-slate-800/40';

                container.innerHTML += `
                    <div class="${bgCard} px-3 py-2 rounded-lg flex items-center justify-between border-b border-slate-700/50">
                        <div class="flex items-center min-w-0 w-3/4">
                            <span class="text-sm font-bold text-slate-500 w-6 text-center mr-2">#${rank}</span>
                            <div class="min-w-0 flex-1">
                                <div class="flex justify-between items-baseline pr-2">
                                    <h3 class="text-sm font-bold text-slate-200 truncate" title="${p.nome}">${p.nome}</h3>
                                </div>
                                <div class="flex items-center mt-1">
                                    <div class="w-16 bg-slate-900 rounded-full h-1.5 mr-2 overflow-hidden">
                                        <div class="${barColor} h-1.5 rounded-full" style="width: ${pct}%"></div>
                                    </div>
                                    <span class="text-[10px] text-slate-400 font-mono">${p.perfeitas}/${p.viagens} OK</span>
                                </div>
                            </div>
                        </div>
                        <div class="text-right pl-1">
                            <span class="text-xl font-black ${pctColor}">${pct}%</span>
                        </div>
                    </div>
                `;
            });
        }
    </script>
</body>
</html>